-- Created by Arthur Duarte
-- https://github.com/DimplyKhan13/VMwareLog_Hana.git

CREATE PROCEDURE "SCHEMA"."ADDDISK"(
	IN USER_VM_ID VARCHAR(50),
	IN USER_DISK_NAME VARCHAR(20),
	IN USER_DISK_VMWARE_ID VARCHAR(50),
	IN USER_DISK_CAPACITY INTEGER,
	IN USER_DISK_DATASTORE VARCHAR(90)
) LANGUAGE SQLSCRIPT
SQL SECURITY
DEFINER AS
BEGIN
	DECLARE THIS_CHANGE INTEGER;
	DECLARE THIS_VM_NAME_ID INTEGER;
	DECLARE THIS_DISK INTEGER;
	DECLARE THIS_NAME INTEGER;
	DECLARE THIS_CAPACITY INTEGER;
	DECLARE THIS_DATASTORE INTEGER;
	
	IF (SELECT COUNT(*) FROM "SCHEMA"."DISK_CURRENT" WHERE VM_ID = USER_VM_ID AND VMWARE_DISK_ID = USER_DISK_VMWARE_ID)<0 THEN

	ELSE
	BEGIN

	INSERT INTO "SCHEMA"."CHANGES_DATES"(TIME, USER)
	VALUES(NOW(), USER());
	select current_identity_value() into THIS_CHANGE from dummy;

	SELECT NAME_ID into THIS_VM_NAME_ID FROM VM_CURRENT WHERE VM_ID = :USER_VM_ID;

	INSERT INTO "SCHEMA"."DISK_CURRENT"(VM_ID, IS_DELETED, NAME_ID, VMWARE_DISK_ID, CAPACITY_ID, DATASTORE_ID)
	VALUES(USER_VM_ID, 0, 0, USER_DISK_VMWARE_ID, 0, 0);
	select current_identity_value() into THIS_DISK from dummy;

	INSERT INTO "SCHEMA"."DISK_NAME"(NAME, CHANGE_ID, PREVIOUS_ID, VM_NAME_ID, DISK_ID)
	VALUES(USER_DISK_NAME, THIS_CHANGE, 0, THIS_VM_NAME_ID, THIS_DISK);
	select current_identity_value() into THIS_NAME from dummy;

	INSERT INTO "SCHEMA"."DISK_DATASTORE"(DATASTORE, CHANGE_ID, DISK_ID, PREVIOUS_ID, VM_NAME_ID, DISK_NAME_ID)
	VALUES(USER_DISK_DATASTORE, THIS_CHANGE, THIS_DISK , 0, THIS_NAME, THIS_NAME);
	select current_identity_value() into THIS_DATASTORE from dummy;

	INSERT INTO "SCHEMA"."DISK_CAPACITY"(CAPACITY, CHANGE_ID, DISK_ID, PREVIOUS_ID, VM_NAME_ID, DATASTORE_ID, DISK_NAME_ID)
	VALUES(USER_DISK_CAPACITY, THIS_CHANGE, THIS_DISK , 0, THIS_NAME, THIS_DATASTORE, THIS_NAME);
	select current_identity_value() into THIS_CAPACITY from dummy;

	INSERT INTO "SCHEMA"."DISK_CREATED"(CHANGE_ID, DISK_ID, VM_NAME_ID)
	VALUES(THIS_CHANGE, THIS_DISK, THIS_VM_NAME_ID);

	UPDATE "SCHEMA"."DISK_CURRENT"
	SET 
    	NAME_ID = THIS_NAME,
    	CAPACITY_ID = THIS_CAPACITY,
    	DATASTORE_ID = THIS_DATASTORE
	WHERE
    	ID = THIS_DISK;

	END;

	END IF;
END;